#!/bin/bash -e

pkgname=vtk
pkgver=5.10.1

tmpdir=$REPO/tmp/$pkgname
srcdir=$tmpdir/VTK$pkgver
reldir=opt/$pkgname-$pkgver
destdir=$REPO/$reldir

prepare()
{
  mkdir -pv $tmpdir && pushd $tmpdir
  curl -O http://www.vtk.org/files/release/${pkgver:0:4}/vtk-${pkgver}.tar.gz 
  curl -O http://www.vtk.org/files/release/${pkgver:0:4}/vtkdata-${pkgver}.tar.gz 
  tar xvfz vtk-${pkgver}.tar.gz
  tar xvfz vtkdata-${pkgver}.tar.gz
  popd
}

configure()
{
  [[ -d $srcdir/build ]] && rm -rf $srcdir/build
  mkdir -pv $srcdir/build && pushd $srcdir/build

  CXX=mpic++ \
  CC=mpicc \
  cmake \
    -D CMAKE_INSTALL_PREFIX:PATH=$destdir \
    -D BUILD_SHARED_LIBS:BOOL=ON \
    -D BUILD_TESTING:BOOL=OFF \
    -D BUILD_EXAMPLES:BOOL=OFF \
    -D VTK_DATA_ROOT:FILEPATH=$tmpdir/VTKData$pkgver \
    -D VTK_USE_SYSTEM_HDF5:BOOL=ON \
    -D VTK_USE_SYSTEM_TIFF:BOOL=ON \
    -D VTK_USE_SYSTEM_PNG:BOOL=ON \
    -D VTK_USE_SYSTEM_ZLIB:BOOL=ON \
    -D VTK_USE_QT:BOOL=ON \
    -D VTK_USE_GUISUPPORT:BOOL=ON \
    -D VTK_USE_COCOA:BOOL=ON \
    -D VTK_WRAP_PYTHON:BOOL=ON \
    -D VTK_USE_PARALLEL:BOOL=ON \
    -D VTK_USE_PATENTED:BOOL=ON \
    ..
  popd
}

build()
{
  pushd $srcdir/build
  make -j8
  popd
}

package()
{
  # remove old installation
  [ -d $destdir ] && rm -rfv $destdir
  # install new one
  pushd $srcdir/build
  _pythonver=`python -c 'import sys; print("%d.%d" % sys.version_info[:2])'`
  _pythondir=$REPO/$reldir/lib/python${_pythonver}/site-packages/
  mkdir -pv ${_pythondir}
  export PYTHONPATH=${_pythondir}:$PYTHONPATH
  make install
  popd
  
  pushd $destdir
  cat << EOF > setenv
export VTK_DIR=\$REPO/$reldir
DYLD_LIBRARY_PATH=\$VTK_DIR/lib/vtk-5.10:\$DYLD_LIBRARY_PATH
PYTHONPATH=\$VTK_DIR/lib/python${_pythonver}/site-packages:\$PYTHONPATH
EOF
  popd
}

clean()
{
  rm -rfv $tmpdir
}

#prepare
#configure
build
package
#clean
