#!/bin/bash -e

# apparently with framework Accelerate single-precision
# tests fail
BLASLIB="-L/usr/local/Cellar/openblas/0.2.8/lib -lopenblas"
#BLASLIB="-framework Accelerate"

pkgname=superlu
pkgver=4.3

tmpdir=$REPO/tmp/$pkgname
srcdir=$tmpdir/SuperLU_${pkgver}
reldir=opt/$pkgname-$pkgver
destdir=$REPO/$reldir

prepare()
{
  mkdir -pv $tmpdir && pushd $tmpdir
  curl -O http://crd-legacy.lbl.gov/~xiaoye/SuperLU/superlu_${pkgver}.tar.gz
  tar xvfz ${pkgname}_${pkgver}.tar.gz
  popd
}

configure()
{
  pushd $srcdir
  cat <<EOF > make.inc
SuperLUroot = $srcdir
SUPERLULIB  = \$(SuperLUroot)/lib/libsuperlu.a.4.3
TMGLIB      = libtmglib.a

BLASDEF   = -DUSE_VENDOR_BLAS
BLASLIB   = $BLASLIB

LIBS = \$(SUPERLULIB) \$(BLASLIB)

ARCH         = ar
ARCHFLAGS    = cr
RANLIB       = echo

CC           = $LOCALGCC/bin/gcc
CFLAGS       = -DPRNTlevel=0 -Wa,-q -O3 -fPIC
NOOPTS       = -O0 -fPIC -Wa,-q
FORTRAN      = $LOCALGCC/bin/gfortran
FFLAGS       = -Wa,-q -O3 -fPIC
LOADER       = \$(CC)
LOADOPTS     = -Wa,-q
CDEFS        = -DAdd_

MATLAB = 
EOF

  popd
}

build()
{
  pushd $srcdir
  make lib

  # shared lib
  $LOCALGCC/bin/gcc \
      -dynamiclib -install_name lib$pkgname.dylib.4 \
      -Wl,-all_load $srcdir/lib/lib$pkgname.a.$pkgver \
      $BLASLIB \
      -lm \
      -compatibility_version 4 \
      -current_version $pkgver \
      -o $srcdir/lib/lib$pkgname.dylib.$pkgver

  popd
}

package()
{
  # remove old installation
  [ -d $destdir ] && rm -rfv $destdir

  install -d $destdir/lib
  install -m 755 $srcdir/lib/* $destdir/lib
  ln -svf libsuperlu.dylib.$pkgver $destdir/lib/libsuperlu.dylib
  ln -svf libsuperlu.dylib.$pkgver $destdir/lib/libsuperlu.dylib.4

  install -d $destdir/include
  install -m 644 $srcdir/SRC/*.h $destdir/include

  rm -v $destdir/include/{html_mainpage,colamd}.h

  pushd $destdir
  cat << EOF > setenv
export SUPERLU_DIR=\$REPO/$reldir
DYLD_LIBRARY_PATH=\$SUPERLU_DIR/lib:\$DYLD_LIBRARY_PATH
EOF
  popd
}

clean()
{
  rm -rfv $tmpdir
}

