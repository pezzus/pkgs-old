#!/bin/bash -e

source $REPO/setenv

pkgname=readline
pkgver=6.2

tmpdir=$REPO/tmp/$pkgname
srcdir=$tmpdir/$pkgname-$pkgver
reldir=opt/$pkgname-$pkgver
destdir=$REPO/$reldir

_patchurl=http://ftp.gnu.org/gnu/readline/readline-${pkgver}-patches

prepare()
{
    mkdir -pv $tmpdir && pushd $tmpdir
    curl -O http://ftp.gnu.org/gnu/readline/$pkgname-$pkgver.tar.gz
    tar xvfz $pkgname-$pkgver.tar.gz
    
    for p in {1..5}; do
        curl -O $_patchurl/readline${pkgver//./}-00$p
        pushd $srcdir
        patch -Np0 -i ../readline${pkgver//./}-00$p
        popd
    done
  
    pushd $srcdir
    patch -Np0 -i $REPO/src/readline/shobj_darwin.patch
    popd
  
    popd
}

configure()
{
    [[ -d $srcdir/build ]] && rm -rf $srcdir/build
    mkdir -pv $srcdir/build && pushd $srcdir/build
  
    ../configure \
        --build="x86_64-apple-darwin12.4.0" \
        --prefix=$destdir \
        --enable-multibyte

    popd
}

build()
{
    pushd $srcdir/build
    make
    popd
}

package()
{
  # remove old installation
  [ -d $destdir ] && rm -rfv $destdir
  # install new one
  pushd $srcdir/build
  make install
  popd
  pushd $destdir
  cat << EOF > setenv
export READLINE_DIR=\$REPO/$reldir
MANPATH=\$READLINE_DIR/share/man:\$MANPATH
INFOPATH=\$READLINE_DIR/share/info:\$INFOPATH
DYLD_LIBRARY_PATH=\$READLINE_DIR/lib:\$DYLD_LIBRARY_PATH
EOF
  popd
}

clean()
{
  rm -rfv $tmpdir
}

