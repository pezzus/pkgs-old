#!/bin/bash -e

# deps
source $REPO/setenv

pkgname=scotch
pkgver=6.0.0

tmpdir=$REPO/tmp/$pkgname
srcdir=$tmpdir/scotch_${pkgver}_esmumps/src
reldir=opt/$pkgname-$pkgver
destdir=$REPO/$reldir

prepare()
{
  mkdir -pv $tmpdir && pushd $tmpdir
  curl -O https://gforge.inria.fr/frs/download.php/31832/scotch_${pkgver}_esmumps.tar.gz
  tar xvfz scotch_${pkgver}_esmumps.tar.gz
  popd
}

configure()
{
  pushd $srcdir
  cat <<EOF > Makefile.inc
EXE =
LIB = .a
OBJ = .o

MAKE = make
AR = ar
ARFLAGS = cr
CAT = cat
CCS = cc
CCP = mpicc
CCD = mpicc
CFLAGS = -O3 -march=native -DCOMMON_FILE_COMPRESS_GZ -DCOMMON_TIMING_OLD -DCOMMON_PTHREAD -DCOMMON_PTHREAD_BARRIER -DCOMMON_RANDOM_FIXED_SEED -DSCOTCH_RENAME -Drestrict=__restrict -DINTSIZE32
CLIBFLAGS = -fPIC
LDFLAGS = -lm -lz
CP = cp
LEX = flex -Pscotchyy -olex.yy.c
LN = ln
MKDIR = mkdir
MV = mv
RANLIB = echo
YACC = bison -pscotchyy -y -b y
EOF
  popd
}

build()
{
  pushd $srcdir
  make scotch
  make esmumps
  make ptscotch
  make ptesmumps
  popd
}

package()
{
  # remove old installation
  [ -d $destdir ] && rm -rfv $destdir

  for dir in {bin,lib,include}; do
    install -d $destdir/$dir
    install -m 755 $srcdir/../$dir/* $destdir/$dir
  done

  rm $destdir/{include,lib}/*metis*

  pushd $destdir/lib
  for lib in libscotcherr{,exit}; do
    cc -dynamiclib -install_name $lib.dylib.6 \
       -compatibility_version 6.0 \
       -current_version $pkgver \
       -Wl,-all_load $lib.a \
       -o $lib.dylib.$pkgver
    ln -svf $lib.dylib.$pkgver $lib.dylib
    ln -svf $lib.dylib.$pkgver $lib.dylib.6
    ln -svf $lib.dylib.$pkgver $lib.dylib.6.0
    rm $lib.a
  done

  cc -dynamiclib -install_name libscotch.dylib.6 \
     -compatibility_version 6.0 \
     -current_version $pkgver \
     -Wl,-all_load libscotch.a \
     -lz -L. -lscotcherr \
     -o libscotch.dylib.$pkgver
  ln -svf libscotch.dylib.$pkgver libscotch.dylib
  ln -svf libscotch.dylib.$pkgver libscotch.dylib.6
  ln -svf libscotch.dylib.$pkgver libscotch.dylib.6.0
  rm libscotch.a

  cc -dynamiclib -install_name libesmumps.dylib.6 \
     -compatibility_version 6.0 \
     -current_version $pkgver \
     -Wl,-all_load libesmumps.a \
     -lz -L. -lscotcherr -lscotch \
     -o libesmumps.dylib.$pkgver
  ln -svf libesmumps.dylib.$pkgver libesmumps.dylib
  ln -svf libesmumps.dylib.$pkgver libesmumps.dylib.6
  ln -svf libesmumps.dylib.$pkgver libesmumps.dylib.6.0
  rm libesmumps.a

  for lib in libptscotcherr{,exit}; do
    mpicc -dynamiclib -install_name $lib.dylib.6 \
       -compatibility_version 6.0 \
       -current_version $pkgver \
       -Wl,-all_load $lib.a \
       -o $lib.dylib.$pkgver
    ln -svf $lib.dylib.$pkgver $lib.dylib
    ln -svf $lib.dylib.$pkgver $lib.dylib.6
    ln -svf $lib.dylib.$pkgver $lib.dylib.6.0
    rm $lib.a
  done

  mpicc -dynamiclib -install_name libptscotch.dylib.6 \
     -compatibility_version 6.0 \
     -current_version $pkgver \
     -Wl,-all_load libptscotch.a \
     -lz -L. -lptscotcherr -lscotch \
     -o libptscotch.dylib.$pkgver
  ln -svf libptscotch.dylib.$pkgver libptscotch.dylib
  ln -svf libptscotch.dylib.$pkgver libptscotch.dylib.6
  ln -svf libptscotch.dylib.$pkgver libptscotch.dylib.6.0
  rm libptscotch.a

  cc -dynamiclib -install_name libptesmumps.dylib.6 \
     -compatibility_version 6.0 \
     -current_version $pkgver \
     -Wl,-all_load libptesmumps.a \
     -lz -L. -lptscotcherr -lptscotch -lscotch \
     -o libptesmumps.dylib.$pkgver
  ln -svf libptesmumps.dylib.$pkgver libptesmumps.dylib
  ln -svf libptesmumps.dylib.$pkgver libptesmumps.dylib.6
  ln -svf libptesmumps.dylib.$pkgver libptesmumps.dylib.6.0
  rm libptesmumps.a

  popd

  pushd $destdir
  cat << EOF > setenv
export SCOTCH_DIR=\$REPO/$reldir
PATH=\$SCOTCH_DIR/bin:\$PATH
DYLD_LIBRARY_PATH=\$SCOTCH_DIR/lib:\$DYLD_LIBRARY_PATH
EOF
  popd
}

clean()
{
  rm -rfv $tmpdir
}

